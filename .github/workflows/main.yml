name: Build FIPS-Compliant OpenSSL
run-name: builder
on: [push]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      # âœ… Use Microsoft's official MSBuild setup instead of Chocolatey
      - name: Setup MSBuild (Includes `nmake` and `cl.exe`)
        uses: microsoft/setup-msbuild@v1.3.1

      - name: Verify MSBuild & nmake
        shell: cmd
        run: |
          echo "Checking MSBuild setup..."
          where msbuild
          where nmake
          where cl
          nmake /?
          cl

      - name: Install NASM
        shell: cmd
        run: |
          powershell -Command "Invoke-WebRequest -Uri 'https://www.nasm.us/pub/nasm/releasebuilds/2.16.03/win64/nasm-2.16.03-installer-x64.exe' -OutFile 'nasm-installer.exe'"
          start /wait nasm-installer.exe /S
          echo "Installed NASM"
          set PATH=C:\Program Files\NASM;%PATH%
          echo PATH=C:\Program Files\NASM;%PATH%>> %GITHUB_ENV%
          where nasm
          nasm -v

      - name: Download and Extract OpenSSL
        shell: cmd
        run: |
          powershell -Command "Invoke-WebRequest -Uri 'https://www.openssl.org/source/openssl-3.0.8.tar.gz' -OutFile 'openssl.tar.gz'"
          tar -xf openssl.tar.gz
          echo "Extracted OpenSSL"

      - name: Build OpenSSL with FIPS Mode
        shell: cmd
        run: |
          cd openssl-3.0.8
          perl Configure VC-WIN64A fips --with-nasm="C:\Program Files\NASM\nasm.exe"
          nmake
          nmake install
          echo "OpenSSL Build Completed"

      - name: Verify OpenSSL Build
        shell: cmd
        run: |
          openssl version -a
          openssl fips
